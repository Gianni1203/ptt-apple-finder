name: Scrape PTT MacShop

on:
  schedule:
    - cron: '0 */12 * * *' # 每 12 小時自動執行一次 (UTC 時間)
  workflow_dispatch:      # 允許你在 Actions 分頁手動點擊按鈕執行

permissions:
  contents: write         # 給予寫入權限，這樣才能把 data.json 存回去

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 cloudscraper

    - name: Run Scraper
      run: |
        python scraper.py

    - name: Commit and push changes
      run: |
        git config --global user.name 'GitHub Actions'
        git config --global user.email 'actions@github.com'
        
        # 步驟 1：先把剛爬到的 data.json 加入暫存
        git add data.json
        
        # 步驟 2：直接 Commit！
        # 這樣檔案就從「Unstaged (未保存)」變成「Committed (已保存)」
        # 加上 || exit 0 是為了防止如果沒有資料變更時報錯
        git diff --staged --quiet || git commit -m "Update data.json"
        
        # 步驟 3：現在檔案安全了，我們可以跟遠端同步 (Pull)
        # 這樣就算你在網頁上改了程式碼，機器人會把你的修改合併進來
        git pull --rebase
        
        # 步驟 4：最後推上去
        git push
